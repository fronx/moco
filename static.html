<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="http://codemirror.net/lib/codemirror.css" />
  <link rel="stylesheet" type="text/css" href="css/theme-moco.css" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <script src="https://raw.github.com/fronx/moco/master/moco.js"></script>
  <script src="https://raw.github.com/marijnh/CodeMirror/master/lib/codemirror.js"></script>
  <script src="https://raw.github.com/marijnh/CodeMirror/master/addon/fold/foldcode.js"></script>
  <script src="https://raw.github.com/marijnh/CodeMirror/master/mode/javascript/javascript.js"></script>
</head>
<body>
  <div class="controls">
    <a href="javascript:Moco.clearHighlights();">clear</a>
    <a href="javascript:Moco.expandAll();">expand</a>
  </div>
<script>
window.onload = function() {
  // url = 'https://github.com/marijnh/acorn/blob/master/acorn_loose.js';
  code = "(function () {\n\nMoco = {};\n\n\x2F\x2F http:\x2F\x2Fstackoverflow.com\x2Fquestions\x2F2820249\x2Fbase64-encoding-and-decoding-in-client-side-javascript\nfunction decodeBase64 (s) {\n  var e={},i,k,v=[],r=\'\',w=String.fromCharCode;\n  var n=[[65,91],[97,123],[48,58],[43,44],[47,48]];\n\n  for(z in n){for(i=n[z][0];i\x3Cn[z][1];i++){v.push(w(i));}}\n  for(i=0;i\x3C64;i++){e[v[i]]=i;}\n\n  for(i=0;i\x3Cs.length;i+=72){\n    var b=0,c,x,l=0,o=s.substring(i,i+72);\n    for(x=0;x\x3Co.length;x++){\n      c=e[o.charAt(x)];b=(b\x3C\x3C6)+c;l+=6;\n        while(l\x3E=8){r+=w((b\x3E\x3E\x3E(l-=8))%256);}\n    }\n  }\n  return r;\n}\n\nfunction get (url, fn) {\n  var request = new XMLHttpRequest();\n  request.open(\'GET\', url, true);\n  request.onload = function () {\n    fn(this.responseText);\n  };\n  request.send(null);\n}\n\nfunction loadScript (url) {\n  document.body\n    .appendChild(document.createElement(\'script\'))\n    .src = url;\n}\n\nfunction loadStyles (url) {\n  elem = document.createElement(\'link\');\n  elem.rel = \'stylesheet\';\n  elem.type = \'text\x2Fcss\';\n  elem.href = url;\n  document.body.appendChild(elem);\n}\n\nfunction toArray (weirdness) {\n  return Array.prototype.slice.call(weirdness);\n}\n\nfunction isKeyWord (token, keyword) {\n  return (token.className == \"cm-keyword\") \&\& (token.innerHTML == keyword)\n}\n\nfunction $$ (selector) {\n  return toArray(document.querySelectorAll(selector));\n}\n\nMoco.unpackContentAsCode = function (response) {\n  var doc = JSON.parse(response);\n  var lines64 = doc[\'content\'].split(\"\\n\")\n  var lines = decodeBase64(lines64.join(\'\'));\n  lines = lines.split(\"\\n\");\n  lines.pop();\n  var code = lines.join(\"\\n\");\n  return code;\n}\n\nMoco.createTextArea = function () {\n  var elem = document.createElement(\'textarea\');\n  document.body.appendChild(elem);\n  return elem;\n}\n\nMoco.initEditor = function (textarea, code, mode) {\n  textarea.value = code;\n  Moco.foldFunc = CodeMirror.newFoldFunction(CodeMirror.braceRangeFinder);\n  window.editor = CodeMirror.fromTextArea(textarea, {\n    mode:         mode,\n    lineWrapping: false,\n    readOnly:     \'nocursor\',\n    lineNumbers:  false,\n    fixedGutter:  false,\n    theme:        \'moco\',\n    gutters:      [ \'fold\' ]\n  });\n  \x2F\x2F window.editor.setGutterMarker(line, gutterID, value)\n  window.editor.on(\"gutterClick\", Moco.foldFunc);\n  window.editor.on(\'update\', function () { console.log(\'cm.update\') });\n  Moco.setUpTokenTouchEvents();\n  return window.editor;\n}\n\nMoco.tokenElements = function () {\n  return $$(\'.CodeMirror-lines pre span\');\n}\n\nMoco.filteredTokenElements = function (type, value) {\n  return Moco.tokenElements().filter(function (token) {\n    return (token.innerHTML == value) \x2F\x2F ignore type for now. because definition\x2Fuse. (token.className == type) \&\&\n  })\n}\n\nMoco.clearHighlights = function () {\n  $$(\'.CodeMirror-lines pre span.highlight\').forEach(function (elem) {\n    elem.classList.remove(\'highlight\');\n  })\n}\n\nMoco.clearPreHighlights = function () {\n  $$(\'.CodeMirror-lines pre span.pre-highlight\').forEach(function (elem) {\n    elem.classList.remove(\'pre-highlight\');\n  })\n}\n\nMoco.highlight = function (type, value) {\n  Moco.clearPreHighlights();\n  Moco.clearHighlights();\n  Moco.filteredTokenElements(type, value).forEach(function (token) {\n    token.classList.add(\'highlight\')\n  })\n}\n\nMoco.preHighlight = function (type, value) {\n  Moco.filteredTokenElements(type, value).forEach(function (token) {\n    token.classList.add(\'pre-highlight\')\n  })\n}\n\nMoco.setUpTokenTouchEvents = function () {\n  function preHighlight (token) {\n    if (token.tagName == \'SPAN\') {\n      console.log(token);\n      Moco.preHighlight(token.classList[0], token.outerText);\n    }\n  }\n  function highlight (token) {\n    if (token.tagName == \'SPAN\') {\n      Moco.highlight(token.classList[0], token.outerText);\n    }\n  }\n  document.addEventListener(\"touchstart\", function (evt) {\n    console.log(\'touchstart\');\n    preHighlight(evt.target)\n  }, false);\n  document.addEventListener(\"touchend\", function (evt) {\n    console.log(\'touchend\');\n    highlight(evt.target)\n  }, false);\n}\n\nMoco.githubApiUrl = function (url) {\n  return url.replace(\'\x2F\x2Fgithub.com\', \'\x2F\x2Fapi.github.com\x2Frepos\').replace(\'\x2Fblob\x2Fmaster\x2F\', \'\x2Fcontents\x2F\');\n}\n\nMoco.editor = function (url, mode) {\n  get(Moco.githubApiUrl(url), function (response) {\n    Moco.initEditor(\n      Moco.createTextArea(),\n      Moco.unpackContentAsCode(response),\n      mode\n    );\n  });\n}\n\nMoco.editorLineElements = function () {\n  return $$(\'.CodeMirror-lines pre\');\n}\n\nMoco.linesWithFunction = function () {\n  return Moco.editorLineElements().reduce(function (acc, line, index) {\n    if (toArray(line.children).some(function (token) { return isKeyWord(token, \'function\') })) {\n      return acc.concat([index - 1])\n    } else {\n      return acc\n    }\n  }, []) \x2F\x2F initial value\n}\n\nMoco.expandAll = function () {\n  editor.eachLine(function (handle) {\n    Moco.foldFunc(editor, editor.getLineNumber(handle));\n  })\n}\n\nMoco.replacePage = function () {\n  \x2F\x2F gather info\n  var codeFileUrl = window.location.href;\n\n  \x2F\x2F remove all the content!!!\n  while (document.body.firstChild) { document.body.removeChild(document.body.firstChild) };\n  while (document.head.firstChild) { document.head.removeChild(document.head.firstChild) };\n\n  \x2F\x2F the post-content world\n  loadStyles(\'https:\x2F\x2Fraw.github.com\x2Fmarijnh\x2FCodeMirror\x2Fmaster\x2Flib\x2Fcodemirror.css\');\n  loadScript(\'https:\x2F\x2Fraw.github.com\x2Fmarijnh\x2FCodeMirror\x2Fmaster\x2Flib\x2Fcodemirror.js\');\n  loadScript(\'https:\x2F\x2Fraw.github.com\x2Fmarijnh\x2FCodeMirror\x2Fmaster\x2Faddon\x2Ffold\x2Ffoldcode.js\');\n\n  Moco.editorFromUrl(codeFileUrl);\n}\n\n})();";

  editor = Moco.initEditor(
    Moco.createTextArea(),
    code,
    "javascript"
  );

  Moco.linesWithFunction().reverse().forEach(function (lineNum) {
    console.log(lineNum);
    editor.addLineClass(lineNum, "text", "function");
    Moco.foldFunc(editor, lineNum);
  });
}
</script>
</body>
</html>